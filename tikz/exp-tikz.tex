%!TEX encoding=UTF-8 Unicode
\documentclass[tikz,a4paper,portrait]{standalone}
\usepackage{tikz}
\input{../custom/magic}

% Libraries
\usetikzlibrary{shapes,arrows,decorations,decorations.pathreplacing,decorations.markings,fit}
\usetikzlibrary{positioning,backgrounds,calc}

% Layers
\pgfdeclarelayer{background}
\pgfdeclarelayer{bg1}
\pgfdeclarelayer{foreground}
\pgfdeclarelayer{ff}
\pgfsetlayers{background,bg1,main,foreground,ff}

\definecolor{Expecol}{HTML}{B2ABD2}
\definecolor{Analysecol}{HTML}{FDB863}
\definecolor{Resultcol}{HTML}{E66101}
\definecolor{distribcol}{HTML}{5E3C99}

\tikzstyle{distrib} = [drawed box=distribcol]
\tikzstyle{Expebox} = [filled box=Expecol]

\tikzstyle{dep}  = [->,Expecol,thick]
\tikzstyle{exec} = [->,Resultcol,thick]
\tikzstyle{copy} = [->, dashed, thick, Analysecol]

\newlength{\cornerlength}
\setlength{\cornerlength}{.141cm}

\tikzset{
  basic box/.style = {
    shape = rectangle,
    draw,
    text centered,
    text width=6em,
    node distance=8em,
    },
  rounded box/.style={
    basic box,
    rounded corners,
  },
  drawed box/.style ={
    rounded box,
    inner sep=1em,
    draw = #1,},
  filled box/.style = {
    rounded box,
    draw  = #1,
    fill  = #1,},
  corner/.style={
      shape=rectangle,
      fill=white,
      alias=this,
      append after command = {
          \pgfextra{
              \begin{pgfonlayer}{ff}
                \draw [] (this.south west) -- (this.south east);
                \draw [] (this.south west) -- (this.north west);
                \draw [] (this.north west) -- (this.south east);
              \end{pgfonlayer}
            }
      }
  },
  file/.style ={
      basic box,
      fill = Expecol,
      minimum height = 5.5em,
      text width = 4em,
      node distance=5em,
      append after command = {
            \pgfextra{\let\TikZlastnode\tikzlastnode}
            node [corner] (corner-TikZlastnode) at
            ([xshift=-\cornerlength,yshift=-\cornerlength]\TikZlastnode.north east){}
          }
  },
  fileA/.style ={
      file,
      fill =Analysecol,
  },
  fileR/.style ={
      file,
      fill =Resultcol,
  },
  header node/.style = {
    %Minimum Width = header nodes,
    font          = \strut\large,%\ttfamily,
  %  text depth    = +0pt,
    fill          = #1,
    text         = white,
    draw},
    header/.style n args={4}{%
    inner ysep = +1.7em,
    append after command = {
      \pgfextra{\let\TikZlastnode\tikzlastnode}
      node [header node=#2,#4] (header-\TikZlastnode) at (\TikZlastnode.#3) {#1}
      %node %[span = (\TikZlastnode)(header-\TikZlastnode)]
       % at (fit bounding box) (h-\TikZlastnode) {}
    }
  },
  hv/.style = {to path = {-|(\tikztotarget)\tikztonodes}},
  vh/.style = {to path = {|-(\tikztotarget)\tikztonodes}},
  fat blue line/.style = {ultra thick, blue}
}
\begin{document}
\begin{tikzpicture}[node distance = 2cm,scale=0.8]rotate=90

    %expe env
    \begin{pgfonlayer}{foreground}


    \node [Expebox,rotate=90,anchor=west] (configs) {Benchmarks, Runtimes, Inputs \ldots};
    \node [Expebox,above right=1em and 2em of configs,rotate=90,anchor=west] (venv) {Virtual environment};

    \node [file, below right=.6em and 1em of configs] (main) {Main script};
    \node [fileA,below=.5em of main] (filt) {Parsing script};
    \node [fileA,below=.5em of filt] (ana) {Analysis script};

    \node [file, above=.5em of main] (dpl) {Launch script};

    \node [Expebox, right=2.5em of main,rotate=90,anchor=north] (mach) {Experimental machine(s)};
    \end{pgfonlayer}

    \begin{pgfonlayer}{bg1}
        \node[distrib,fit=(configs) (venv) (ana) (filt) (main) (dpl) (mach),%
        header={Experimental plan}{distribcol}{north}{}] (distenv) {};
    \end{pgfonlayer}

    % Analysis env

    \begin{pgfonlayer}{foreground}
        \node[fileR, right=9em of main] (raw) {Raw results};
        \node[fileR, above=.5em of raw] (mi) {Meta data};
        \node[fileA, below=.5em of raw] (filt1) {Parsing script};
        \node[fileA, below=.5em of filt1] (ana1) {Analysis script};
    \end{pgfonlayer}

    \begin{pgfonlayer}{foreground}
        % \node[right=3.5em  of mi] (inv0) {};
        \node[fileR, right=3.5em  of raw] (csv) {Filtered results};
        \node[fileA, below = .5em of csv] (ana2) {Analysis script};
    \end{pgfonlayer}

    \begin{pgfonlayer}{bg1}
        \node[distrib,fit=(raw) (mi) (filt1) (ana1),%
        header={Raw analysis}{distribcol}{north}{}] (rawa) {};
    \end{pgfonlayer}

    \node[fileR, right = 3.5em of csv] (res) {Human readable results};

    \begin{pgfonlayer}{bg1}
        \node[distrib,fit=(csv) (ana2),%
        header={Statistical analysis}{distribcol}{north}{text width=5em}] (stata) {};
    \end{pgfonlayer}


    % Paths

    \draw[dep] (configs.south) -- node[color=Expecol,rotate=90,pos=1.3,above=3em] {depends} (main.west);
    \path[dep] (venv.south) edge[out=0,in=180]  (dpl.west);
    % \path[dep] (configs.east) edge[out=0,in=180] node[above] {use} (mach.west);


     \path[exec] (dpl.east) edge[out=0,in=180]  (mach.north);
     \path[exec] (main.east) edge  (mach.north);
     \path[copy] (ana.east)  edge (ana1.west);
     \path[copy] (filt.east) edge  (filt1.west);

    \path[exec] (mach.south) edge[out=0,in=180] (mi.west);
    \path[exec] (mach.south) edge[out=0,in=180]  node[pos=.85,above=2em,rotate=90] {generate} (raw.west);

    \draw[exec] (raw.east) -- node[pos=.15,below=2em,rotate=90] {generate} (csv.west);
    \path[exec] (filt1.east) edge[out=0,in=180] (csv.west);
    \path[copy] (ana1.east) edge[out=0,in=180] (ana2.west);

    \draw[exec] (csv.east) -- node[pos=.17,below=2em,rotate=90] {generate} (res.west);
    \path[exec] (ana2.east) edge[out=0,in=180] (res.west);

\end{tikzpicture}
\end{document}
