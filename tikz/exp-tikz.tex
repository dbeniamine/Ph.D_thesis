%!TEX encoding=UTF-8 Unicode
\documentclass[tikz]{standalone}
\usepackage{tikz}
\input{../custom/magic}

% Libraries
\usetikzlibrary{shapes,arrows,decorations,decorations.pathreplacing,decorations.markings,fit}
\usetikzlibrary{positioning,backgrounds,calc}

% Layers
\pgfdeclarelayer{background}
\pgfdeclarelayer{bg1}
\pgfdeclarelayer{foreground}
\pgfdeclarelayer{ff}
\pgfsetlayers{background,bg1,main,foreground,ff}
%% Figure: tikz/exp-tikz.tex
\definecolor{envcol}{HTML}{3B8ECC}
\definecolor{distribcol}{HTML}{FF000A}
\definecolor{groupcol}{HTML}{FDAE61}
\definecolor{conceptcol}{HTML}{ABD9E9}
\definecolor{filecol}{HTML}{ABD9E9}

\tikzstyle{env} = [drawed box=envcol, dashed]
\tikzstyle{distrib} = [drawed box=distribcol]
\tikzstyle{group} = [drawed box=groupcol]
\tikzstyle{concept} = [filled box=conceptcol]

\tikzstyle{dep} = [->,filecol,thick]
\tikzstyle{exec} = [->,distribcol,thick]
\tikzstyle{copy} = [->, dashed, thick, groupcol]

\newlength{\cornerlength}
\setlength{\cornerlength}{.145cm}

\tikzset{
  basic box/.style = {
    shape = rectangle,
    draw,
    text centered,
    text width=6em,
    node distance=8em,
    },
  rounded box/.style={
    basic box,
    rounded corners,
  },
  drawed box/.style ={
    rounded box,
    inner sep=1em,
    draw = #1,},
  filled box/.style = {
    rounded box,
    draw  = #1,
    fill  = #1,},
  corner/.style={
      shape=rectangle,
      fill=white,
      alias=this,
      append after command = {
          \pgfextra{
              \begin{pgfonlayer}{ff}
                \draw [black,thin] (this.south west) -- (this.south east);
                \draw [black,thin] (this.south west) -- (this.north west);
                \draw [black,thin] (this.north west) -- (this.south east);
              \end{pgfonlayer}
            }
      }
  },
  file/.style ={
      basic box,
      draw = black,
      fill = filecol,
      minimum height = 5.5em,
      text width = 4em,
      node distance=5em,
      append after command = {
            \pgfextra{\let\TikZlastnode\tikzlastnode}
            node [corner] (corner-TikZlastnode) at
            ([xshift=-\cornerlength,yshift=-\cornerlength]\TikZlastnode.north east){}
          }
  },
  header node/.style = {
    %Minimum Width = header nodes,
    font          = \strut\large,%\ttfamily,
  %  text depth    = +0pt,
    fill          = #1,
    draw},
    header/.style n args={4}{%
    inner ysep = +1.7em,
    append after command = {
      \pgfextra{\let\TikZlastnode\tikzlastnode}
      node [header node=#2,#4] (header-\TikZlastnode) at (\TikZlastnode.#3) {#1}
      %node %[span = (\TikZlastnode)(header-\TikZlastnode)]
       % at (fit bounding box) (h-\TikZlastnode) {}
    }
  },
  hv/.style = {to path = {-|(\tikztotarget)\tikztonodes}},
  vh/.style = {to path = {|-(\tikztotarget)\tikztonodes}},
  fat blue line/.style = {ultra thick, blue}
}
\begin{document}
\begin{tikzpicture}[node distance = 2cm,scale=0.8]rotate=90

    %expe env
    \begin{pgfonlayer}{foreground}


    \node [concept,rotate=90,anchor=west] (configs) {Benchmarks, Runtimes, Inputs \ldots};
    \node [concept,above right=1em and 2em of configs,rotate=90,anchor=west] (venv) {Virtual environment};

    \node [file, below right=.6em and 1em of configs] (main) {Main script};
    \node [file, below=.5em of main] (filt) {Parsing script};
    \node [file, below=.5em of filt] (ana) {Analysis script};

    \node [file, above=.5em of main] (dpl) {Launch scripts};

    \node [concept, right=2.5em of main,rotate=90,anchor=north] (mach) {Experimental machine(s)};
    \end{pgfonlayer}

    %\node [group,fit=(configs) (main) (filt) (ana),header={Experimental plan}
    %{groupcol}{north}{}] (plan) {};

    \begin{pgfonlayer}{bg1}
        \node[distrib,fit=(configs) (venv) (ana) (filt) (main) (dpl),%
        header={Experimental plan}{distribcol}{north}{}] (distenv) {};
    \end{pgfonlayer}

    \begin{pgfonlayer}{background}
        \node[env,fit=(distenv) (mach),%
        header={Experiment}{envcol}{south}{}] (expenv) {};
    \end{pgfonlayer}

    % Analysis env

    \begin{pgfonlayer}{foreground}
        \node[file, right=9em of main] (raw) {Raw results};
        \node[file, above=.5em of raw] (mi) {Meta data};
        \node[file, below=.5em of raw] (filt1) {Parsing script};
        \node[file, below=.5em of filt1] (ana1) {Analysis script};
    \end{pgfonlayer}

    \begin{pgfonlayer}{bg1}
        \node[distrib,fit=(raw) (mi) (filt1) (ana1),%
        header={Raw analysis}{distribcol}{north}{}] (rawa) {};
    \end{pgfonlayer}

    \begin{pgfonlayer}{foreground}
        \node[file, right=3.5em  of raw] (csv) {Filtered results};
        \node[file, below=.5em of csv] (ana2) {Analysis script};
    \end{pgfonlayer}

    \begin{pgfonlayer}{bg1}
        \node[distrib,fit=(csv) (ana2),%
        header={Statistic analysis}{distribcol}{north}{text width=4.5em}] (stata) {};
    \end{pgfonlayer}

    \begin{pgfonlayer}{foreground}
        \node[file, right=3em of csv] (res) {Analysis results};
        %\node [concept, right of=res] (com) {Comments};
        %\node [file, below= 3em of res] (pap) {Article};
    \end{pgfonlayer}

    \begin{pgfonlayer}{background}
        \node[env,fit=(rawa) (stata) (res),%
        header={Analysis}{envcol}{south}{}] (anaenv) {};
    \end{pgfonlayer}

    % Paths

    \begin{pgfonlayer}{background}
        \path[dep] (configs.south) edge node[rotate=90,pos=1.3,above=3em] {depends} (main.west);
        \path[dep] (venv.south) edge[out=0,in=180]  (dpl.west);
    \end{pgfonlayer}
    % \path[dep] (configs.east) edge[out=0,in=180] node[above] {use} (mach.west);


     \path[exec] (dpl.east) edge[out=0,in=180]  (mach.north);
     \path[exec] (main.east) edge  (mach.north);
     \path[copy] (ana.east)  edge (ana1.west);
     \path[copy] (filt.east) edge  (filt1.west);

    \path[exec] (mach.south) edge[out=0,in=180] node[pos=.2,above=2em,rotate=90] {generate} (mi.west);
    \path[exec] (mach.south) edge[out=0,in=180] (raw.west);

    \draw[exec] (raw.east) -- node[pos=.7,above=2em,rotate=90] {generate} (csv.west);
    \path[exec] (filt1.east) edge[out=0,in=180] (csv.west);
    \path[copy] (ana1.east) edge[out=0,in=180] (ana2.west);

    \draw[exec] (csv.east) -- node[pos=.9,above=2em,rotate=90] {generate} (res.west);
    \path[exec] (ana2.east) edge[out=0,in=180] (res.west);

    %\draw[exec] (res.south) -- node[left] {generate} (pap.north);
    %\path[exec] (com.east) edge[out=0,in=180] (pap.west);
\end{tikzpicture}
\end{document}
