%!TEX encoding=UTF-8 Unicode

\tikzset{
    box/.style={
        shape=rectangle,
        draw,
    },
    pics/core/.style args={#1#2}{
        % Args: #1: nb PU, #2 core id
        code={
            \pgfmathtruncatemacro{\pmin}{#1*#2}
            \pgfmathtruncatemacro{\pmax}{\pmin+#1-1}
            %PUs
            \foreach \pu in {\pmin,...,\pmax}{
                \pgfmathtruncatemacro{\pstep}{\pu-\pmin}
                \node[box] (PU-\pu)at ($(0,0)+(0,-.7*\pstep)$) {PU\#\pu};
            }
            %Core ID
            \node (name) at ($(PU-\pmin)!0.5!(PU-\pmax)+(0,1)$) {Core\##2};
            % L1
            \node[box,inner sep=2pt, fit=(name) (PU-\pmin) (PU-\pmax)] (box) {};
            \draw ($(box.north west)+(0,.1)$) rectangle ($(box.north east)+(0,.5)$)%
                node[pos=.5] (l1) {L1};
            % Coordinate for drawing L2
            \coordinate (core-#2-w) at ($(box.north west)+(0,.5)$);
            \coordinate (core-#2-e) at ($(box.north east)+(0,.5)$);
            % links
            \draw (box.north) -- (l1.south);
        }
    },
    pics/l2group/.style args={#1#2}{
        % Args: #1: nb Cores, #2 group id
        code={
            \pgfmathtruncatemacro{\cmin}{#1*#2}
            \pgfmathtruncatemacro{\cmax}{\cmin+#1-1}
            % Cores
            \foreach \core in {\cmin,...,\cmax}{
                \pgfmathtruncatemacro{\cstep}{\core-\cmin}
                \draw ($(0,0)+(1.6*\cstep,0)$) pic {core={2}{\core}};
            }
            % L2
            \draw ($(core-\cmin-w)+(0,.1)$) rectangle ($(core-\cmax-e)+(0,.5)$)%
                node[pos=.5]{L2};
            % Coordinates for L3
            \coordinate (l2g-#2-w) at ($(core-\cmin-w)+(0,.5)$);
            \coordinate (l2g-#2-e) at ($(core-\cmax-e)+(0,.5)$);
            %links
            \foreach \core in {\cmin,...,\cmax}{
                \draw ($(core-\core-w)!.5!(core-\core-e)$) --
                    ($(core-\core-w)!.5!(core-\core-e)+(0,.1)$);
            }
        }
    },
    pics/socket/.style args={#1#2}{
        % Args: #1: nb l2 groups, #2 socket id
        code={
            \pgfmathtruncatemacro{\lmin}{#1*#2}
            \pgfmathtruncatemacro{\lmax}{\lmin+#1-1}
            % Cores
            \foreach \lg in {\lmin,...,\lmax}{
                \draw ($(0,0)+(3.2*\lg,0)$) pic {l2group={2}{\lg}};
            }
            % L2
            \draw ($(l2g-\lmin-w)+(0,.1)$) rectangle ($(l2g-\lmax-e)+(0,.5)$)%
                node[pos=.5]{L3};
            % Coordinates for Mem
            \coordinate (s-#2-w) at ($(l2g-\lmin-w)+(0,.5)$);
            \coordinate (s-#2-e) at ($(l2g-\lmax-e)+(0,.5)$);
            % links
            \foreach \lg in {\lmin,...,\lmax}{
                \draw ($(l2g-\lg-w)!.5!(l2g-\lg-e)$) --
                    ($(l2g-\lg-w)!.5!(l2g-\lg-e)+(0,.1)$);
            }
            % CPU
            \node (minnode) at ($(-.7,-1)+(3.2*\lmin,0)$) {};
            \node (maxnode) at ($(l2g-\lmax-e)+(-.1,1)$) {};
            \node [anchor=west] (sockname) at ($(l2g-\lmin-w)+(0,.8)$) {Socket \##2};

            \node[box,fit=(minnode) (maxnode)] (cpu-#2) {};
            % Memory
            \draw ($(s-#2-w)+(0,1.5)$) rectangle ($(s-#2-e)+(0,2.5)$)%
                node[pos=.5]{Memory \##2};

            \draw ($(s-#2-w)!.5!(s-#2-e)+(0,.75)$) -- ($(s-#2-w)!.5!(s-#2-e)+(0,1.5)$);

        }
    },
}

\begin{tikzpicture}[font=\small, every pic/.style={scale=1}]
    \pic at (0,0) {socket={2}{0}};
    \pic at (.5,0) {socket={2}{1}};
    % Ugly:
    \draw (2.5,-1.25) |- (7,-2);
    \draw (7,-2) -| (9.5,-1.25);
\end{tikzpicture}
% vim: et si sta lbr  sw=4 ts=4 spelllang=en_us
